[toc]

# 2 原生Android工程

## 构建 NDK 样例应用

### 产生工程文件

构建 Android 自带的样例。A possible choice is the **San Angeles** demo, created in 2004 by Jetro Lauha and later ported to OpenGL ES (more information at [http://jet.ro/visuals/4k-intros/sanangeles-observation/](http://jet.ro/visuals/4k-intros/sanangeles-observation/)).

利用 `android` 命令产生工程：

```
cd $ANDROID_NDK/samples/san-angeles
android update project -p ./
```

You may get the following error upon executing this command:

```
Error: The project either has no target set or the target is invalid.
Please provide a --target to the 'android update' command.
```

This means that you have not installed all the Android SDK platforms as specified in Chapter 1, Setting Up Your Environment. In which case, either install them using the Android manager tool or specify your own project target, for example, `android update project --target 18 -p ./`.

产生以下文件：

- build.xml：Ant 文件，描述如何编译和打包。
- local.properties：配置 Android SDK 位置。
- project.properties：配置目标版本。This file is generated by default from a pre-existing default.properties file in the project directory. If no default.properties exists, then an additional `–target <API Target>` flag must be appended to the android create command.

`android create project` 使我们可以通过命令行创建 Android 工程。

`android update project` 从已存在的代码创建 Android 工程。

### 编辑本地代码

Compile San Angeles native library with `ndk-build`.

`ndk-build` 命令会搭建 Android 编译工具栏（基于 GCC 或 CLang）。

本地代码默认放在 `jni` 工程。

中间对象文件放在 `obj` 目录。最终二进制库放在 `libs`。NDK-related build files can be erased with the following command:

```
ndk-build clean
```

### 编译打包
Build and package San Angeles application in Debug mode:

```
ant debug
```

Make sure your Android device is connected or the emulator is started. Then deploy the generated package:

```
ant installd
```

`ant installd` 用于调试模式。`ant installr` 用于发布模式。

## 你的第一个本地工程
创建 jni 和 obj 目录。

so库命名为 `libcom_packtpub_store_Store.so`

```java
package com.packtpub.store;
public class Store {
    static {
        System.loadLibrary("com_packtpub_store_Store");
    }
}
```

## 在Java里调用C

```java
package com.packtpub.store;
public class Store {
    static {
        System.loadLibrary("com_packtpub_store_Store");
    }
    public native int getCount();
}
```

根据 `Store` 类产生 JNI 头文件。

```
javah -d Store/jni com.packtpub.store.Store
```

产生的 **jni/com_packtpub_store_Store.h**：

```h
    /* DO NOT EDIT THIS FILE - it is machine generated */
    #include <jni.h>
    /* Header for class com_packtpub_store_Store */
    #ifndef _Included_com_packtpub_store_Store
    #define _Included_com_packtpub_store_Store
    #ifdef __cplusplus
    extern "C" {
    #endif
    /*
    * Class: com_packtpub_store_Store
    * Method: getCount
    * Signature: ()I
    */
    JNIEXPORT jint JNICALL Java_com_packtpub_store_Store_getCount (JNIEnv *, jobject);
    #ifdef __cplusplus
    }
    #endif
    #endif
```

**jni/com_packtpub_store_Store.cpp**：

```c
    #include "com_packtpub_store_Store.h"
    JNIEXPORT jint JNICALL Java_com_packtpub_store_Store_getCount (JNIEnv* pEnv, jobject pObject) {
        return 0;
    }
```

## （未）Debugging native Android applications

## （未）Analyzing native crash dumps

## （未）Setting up a Gradle project to compile native code
