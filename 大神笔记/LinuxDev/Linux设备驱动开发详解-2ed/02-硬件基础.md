[toc]

## 2. 驱动设计的硬件基础

本章讲述一个底层驱动工程师必备的硬件基础，给出了嵌入式系统硬件原理及分析方法的一个完整而简洁的全景视图。

2.1节描述了微控制器、微处理器、数字信号处理器以及应用于特定领域的处理器各自的特点，分析了处理器的体系架构和指令集。

2.2节对嵌入式系统中所使用的各类存储器与CPU的接口、应用领域及特点进行了归纳整理。

2.3节分析了常见的外设接口与总线的工作方式，包括串口、I2C、USB、以太网接口、ISA、PCI和cPCI等。

嵌入式系统硬件电路中经常会使用 CPLD 和 FPGA，作为驱动工程师， 我们不需要掌握 CPLD 和 FPGA 的开发方法，但是需要知道它们在电路中能完成什么工作。2.4节讲解了这项内容。

2.5~2.7节给出了在实际项目开发过程中硬件分析的方法，包括如何进行原理图分析、时序分析及如何快速地从芯片手册获取有效信息。

2.8节讲解了调试过程中常用仪器仪表的使用方法，涉及万用表、示波器和逻辑分析仪。

### 2.1 处理器

#### 2.1.1 通用处理器

通用处理器(GPP)并不针对特定的应用领域进行体系结构和指令集的优化，它们具有一般化的通用体系结构和指令集，以求支持复杂的运算并易于添加新开发的功能。

一般而言，在嵌入式**微控制器(MCU)**和**微处理器(MPU)**中会包含一个**通用处理器核**。MPU 通常代表一个 CPU(中央处理器)，而 MCU 则强调把中央处理器、存储器和外围电路集成在一个芯片中。早期，微控制器被称为**单片机**，指把计算机集成在一个芯片内。嵌入式微控制器也常被称作**片上系统(SoC)**，含义是在一个芯片上设计了整个系统。芯片厂商在推出 MCU 时，往往会有明确的市场定位，如定位于 PDA、MP3、ADSL 等。定位不同的产品可能包含共同的 CPU 核，但是集成的扩展电路则不一样。

举个例子，Intel 的 80386 属于微处理器，而内部集成了 80386 处理器、片选单元、中断控制、定时器、看门狗定时器、串行 I/O、DMA 和总线仲裁、DRAM 控制器等。386EX 则是 80386 微处理器的微控制器版本。但是，要说明的是，GPP、MCU 和 MPU 等概念其实非常含糊，许多地方并不加以区分，而明确区分这些概念在技术上本身也没有太大的意义。

嵌入式微控制器一般由一个 CPU 核和多个外围电路集成，目前主流的嵌入式 CPU **核**有如下几种。

- AdvancedRISCMachines公司的ARM。ARM 内核的设计技术被授权给数百家半导体厂商，做成不同的 SoC 芯片。本书所基于的 LDD6410 开发板上采用的就是 S3C6410 这个 ARM SoC 芯片。
- MIPS技术公司的MIPS。
- IBM和Motorola的PowerPC。PowerPC 处理器是通信和工控领域应用最广泛的处理器，国内包括华为、中兴在内的通信公司都大量使用 PowerPC，MPC860 和 MPC8260 是其最经典的两款。
- Motorola公司独有的内核68K/COLDFIRE。68K 内核是最早在嵌入式领域广泛应用的内核，其最著名的代表芯片是 68360。Coldfire 则继承了 68K 的特点并对其保持了兼容。Coldfire 内核被用于 DSP 模块、CAN 总线模块以及一般嵌入式处理器所集成的外设模块，在工业控制、机器人研究、家电控制等领域被广泛采用。

中央处理器的体系架构可以分为两类，一类为冯诺伊曼结构，一类为哈佛结构。

冯-诺伊曼结构也称普林斯顿结构，是一种将程序指令存储器和数据存储器合并在一起的存 储器结构。程序指令存储地址和数据存储地址指向同一个存储器的不同物理位置，因此程序指令和数据的宽度相同。而哈佛结构将程序指令和数据分开存储，指令和数据可以有不同的数据宽度。此外，哈佛结构还采用了独立的程序总线和数据总线，分别作为 CPU 与每个存储器之间的专用通信路径，具有较高的执行效率。

从指令集的角度来讲，中央处理器也可以分为两类，即 RISC(精简指令集计算机)和 CISC (复杂指令集计算机)。CSIC 强调增强指令的能力、减少目标代码的数量，但是指令复杂，指令周期长;而 RISC 强调尽可能减少指令集、指令单周期执行，但是目标代码会更大。ARM、MIPS、PowerPC 等 CPU 内核都采用了 RISC 指令集。目前，RISC 和 CSIC 二者的融合非常明显。

#### 2.1.2 数字信号处理器

数字信号处理器(DSP)针对通信、图像、语音和视频处理等领域的算法而设计。它包含独立的硬件乘法器。DSP 的乘法指令一般在单周期内完成，且优化了卷积、数字滤波、FFT(快速傅立叶变换)、相关、矩阵运算等算法中的大量重复乘法。

DSP 一般采用改进的哈佛架构，它具有独立的地址总线和数据总线，两条总线由程序存储器和数据存储器分时共用。

DSP 分为两类，一类是定点 DSP，一类是浮点 DSP。浮点 DSP 的浮点运算用硬件来实现，可以在单周期内完成，因而其浮点运算处理速度高于定点 DSP。而定点 DSP 只能用定点运算模拟浮点运算。

德州仪器(TI)、美国模拟器件公司(ADI)是全球 DSP 的两大主要厂商。

通用处理器和数字信号处理器也有相互融合以取长补短的趋势，如数字信号控制器(DSC) 即为 MCU+DSP，ADI 的 blackfin 系列就属于 DSC。目前，芯片厂商也推出了许多 ARM+DSP 的双核以及多核的处理器，如TI公司的 **OMAP 4** 平台就包括4个主要处理引擎:ARM Cortex-A9 MPCore、PowerVR SGX 540 GPU(Graphic Processing Unit)、C64x DSP 和 **ISP**(Image Signal Processor)。

对于某些应用场合，使用 ASIC(专用集成电路)往往是低成本且高性能的方案。在复杂的系统中，这些芯片可能会同时存在，协同合作，各自发挥自己的长处。如在一款智能手机中，可使用 MCU 处理图形用户界面和用户 的按键输入并运行多任务操作系统，使用 DSP 进行音视频编解码，而在**射频**方面则采用ASIC。

### 2.2 存储器

目前 ROM 有被 Flash 替代的趋势。

NOR Flash 和 CPU 的接口属于典型的类 SRAM 接口，不需要增加额外的控制电路。NOR Flash 的特点是**可芯片内执行**(XIP，eXecute In Place)，程序可以直接在 NOR 内运行。而NAND Flash和CPU的接口必须由相应的控制电路进行转换，当然也可以通过地 址线或GPIO产生NAND Flash接口的信号。NAND FLASH以块方式进行访问，不支持芯片内执行。

公共闪存接口(Common Flash Interface，简称 CFI)是一个公开的、标准的从 NOR Flash 器 件中读取数据的接口。它可以使系统软件查询已安装的 Flash 器件的各种参数，包括器件阵列结 构参数、电气和时间参数以及器件支持的功能等。利用 CFI，在不修改系统软件的情况下，就可 以用新型的和改进的产品代替旧版本的产品。

NAND Flash 较 NOR Flash 容量大，价格低;NAND Flash 中每个块的最大擦写次数是一百万次，而 NOR 的擦写次数是十万次;NAND Flash 的擦除、编程速度远超过 NOR Flash。

由于 Flash 固有的电器特性，在读写数据过程中，偶然会产生 1 位或几位数据错误，即位反转，NAND Flash 发生位反转的几率要远大于 NOR Flash。位反转无法避免，因此，使用 NAND Flash 的同时，应采用错误探测/错误更正(EDC/ECC)算法。

Flash 的编程原理都是只能将 1 写为 0，而不能将 0 写为 1。所以在 Flash 编程之前，必须将对应的块擦除，而擦除的过程就是把所有位都写为 1 的过程，块内的所有字节变为 0xFF。

许多嵌入式系统都提供了 **IDE**(Integrated Drive Electronics)接口，以供连接**硬盘控制器**或光驱，IDE 接口的信号与 SRAM 类似。人们通常也把 IDE 接口称为 ATA(Advanced Technology Attachment)接口，技术角度而言并不准确。其实，ATA 接口发展至今，已经经历了 ATA-1(IDE)、 ATA-2(EIDE Enhanced IDE/Fast ATA)、ATA-3(FastATA-2)、Ultra ATA、Ultra ATA/33、Ultra ATA/66、 Ultra ATA/100 及 Serial ATA 的发展过程。

### 2.3 接口与总线

#### 2.3.1 串口

RS-232、RS-422 与 RS-485 都是串行数据接口标准，最初都是由电子工业协会(EIA)制订并发布的。

RS-232 在 1962 年发布，命名为 EIA-232-E。之后发布的 RS-422 定义了一种平衡通信接口， 它是一种单机发送、多机接收的单向、平衡传输规范，被命名为 TIA/EIA-422-A 标准。RS-422 改进了 RS-232 通信距离短、速率低的缺点。为进一步扩展应用范围，EIA 又于 1983 年在 RS-422 的基础上制定了 RS-485 标准，增加了多点、双向通信能力，即允许多个发送器连接到同一条总线上，同时增加了发送器的驱动能力和冲突保护特性，并扩展了总线共模范围，被命名为 TIA/EIA-485-A 标准。

1969 年发布的 RS-232 修改版 RS-232C 是嵌入式系统应用最广泛的串行接口，它为连接 DTE (数据终端设备)与 DCE(数据通信设备)而制定。RS-232C 规标准接口有 25 条线(4条数据线、11条控制线、3条定时线、7条备用和未定义线)，常用的只有9根，它们是 RTS/CTS(请求发送/清除发送流控制)、RxD/TxD(数据收发)、DSR/DTR(数据终端就绪/数据设置就绪流控制)、DCD (数据载波检测，也称 RLSD，即接收线信号检出)、Ringing-RI(振铃指示)、SG(信号地)信号。

RTS/CTS、TxD/RxD、DRS/DTR 等信号的定义如下。

- RTS：用来表示DTE请求DCE发送数据，当终端要发送数据时，使该信号有效。
- CTS：用来表示DCE准备好接收DTE发来的数据，是对RTS的响应信号。
- TxD：DTE通过TxD将串行数据发送到DCE。
- RxD：DTE通过RxD接收从DCE发来的串行数据。
- DSR：有效(ON状态)表明DCE可以使用。
- DTR：有效(ON状态)表明DTE可以使用。
- DCD：当本地DCE设备收到对方DCE设备送来的载波信号时，使DCD有效，通知 DTE 准备接收，并且由 DCE 将接收到的载波信号解调为数字信号，经 RXD 线送给 DTE。
- Ringing-RI：当MODEM收到交换台送来的振铃呼叫信号时，使该信号有效(ON状态)，通知终端，已被呼叫。

在嵌入式系统中，并不太注重 DTE 和 DCE 的概念，而 RS-232C 也很少用来连接 modem，多使用 RS-232C 进行对等通信，如 Windows 超级终端、Linux minicom 用来连接电路板控制台等。最简单的 RS-232C 串口只需要连接 RxD、TxD、SG 这 3 个信号，使用 XON/XOFF 软件流控。

组成一个RS-232C串口的硬件，从CPU到连接器依次为：CPU、UART(通用异步接收器发送器，作用是完成并/串转换)、CMOS/TTL 电平与 RS-232C 电平转换、DB9/DB25 或自定义连接器。

#### 2.3.2 I2C

I2C(内置集成电路)总线是由 Philips 公司开发的两线式串行总线，用于连接微控制器及其外围设备。I2C 总线简单而有效，占用很少的 PCB(印刷电路板)空间，芯片管脚数量少，设计成本低。I2C 总线支持多主控(multi-mastering)模式，任何能够进行发送和接收的设备都可以成为主设备。主控能够控制数据的传输和时钟频率，在任意时刻只能有一个主控。

组成 I2C 总线的两个信号为数据线 SDA 和时钟 SCL。为了避免总线信号的混乱，要求各设备连接到总线的输出端必须是开漏输出或集电极开路输出的结构。总线空闲时，上拉电阻使 SDA 和 SCL 线都保持高电平。根据开漏输出或集电极开路输出信号的“线与”逻辑，I2C 总线上任意器件输出低电平都会使相应总线上的信号线变低。

> “线与”指的是两个个或多个输出直接互联就可以实现“AND”的逻辑功能，只有输出端是开漏(对于 CMOS 器件)输出或集电极开路(对于 TTL 器件)输出时才满足此条件。工程师一般以“OC门”简称开漏或集电极开路。

I2C 设备上的串行数据线 SDA 接口电路是双向的，输出电路用于向总线上发送数据，输入电路用于接收总线上的数据。同样地，串行时钟线 SCL 也是双向的，作为控制总线数据传送的主机 要通过 SCL 输出电路发送时钟信号，并检测总线上 SCL 上的电平以决定什么时候发下一个时钟脉冲电平；作为接收主机命令的从设备需按总线上 SCL 的信号发送或接收 SDA 上的信号，它也可以向 SCL 线发出低电平信号以延长总线时钟信号周期。

当 SCL 稳定在高电平时，SDA 由高到低的变化将产生一个开始位，而由低到高的变化则产生一个停止位。

开始位和停止位都由 I2C 主设备产生。在选择从设备时，如果从设备采用 7 位地址，则主设备在发起传输过程前，需先发送 1 字节的地址信息，前 7 位为设备地址，最后 1 位为读写标志。之后，每次传输的数据也是 1 个字节，从 MSB 位开始传输。每个字节传完后，在 SCL 的第 9 个 上升沿到来之前，接收方应该发出 1 个 ACK 位。SCL 上的时钟脉冲由 I2C 主控方发出，在第 8 个时钟周期之后，主控方应该释放 SDA。

#### 2.3.3 USB

USB(通用串行总线)是 Intel、Microsoft 等厂商为解决计算机外设种类的日益增加与有限的主板插槽和端口之间的矛盾而于 1995 年提出的，它具有数据传输率高、易扩展、支持即插即用和热插拔的优点，目前已得到广泛应用。

USB 1.1包含全速和低速两种模式，低速方式的速率为1.5Mbit/s，支持一些不需要很大数据吞吐量和**高实时性**的设备，如鼠标等。全速模式为12Mbit/s，可以外接速率更高的外设。

在USB2.0中，增加了一种高速方式，数据传输率达到480Mbit/s，可以满足更高速外设的需要。

在嵌入式系统中，电路板若需要挂接 USB 设备(device)，则需提供 USB 主机(host)控制器和连接器；若电路板需要作为 USB 设备，则需提供 USB 设备适配器和连接器。有的 MCU 集成了 USB 主机控制器和设备适配器。

USB总线的机械连接非常简单，采用4芯的屏蔽线，一对差分线(D+，D-)传送信号，另一对(VBUS，电源地)传送+5V的直流电。一个USB主控制器端口最多可连接127个器件，各器件之间的距离不超过5米。

USB提供了4种传输方式以适应各种设备的需要，说明如下。

1. **控制(Control)**传输方式。控制传输是双向传输，数据量通常较小，主要用来进行查询、配置和给 USB 设备发送通用的命令。
1. **同步(Synchronization)**传输方式。同步传输提供了确定的带宽和间隔时间，它被用于时间严格并具有较强容错性的流数据传输，或者用于要求恒定的数据传送率的即时应用。例如进行语音业务传输时，使用同步传输方式是很好的选择
1. **中断(Interrupt)**传输方式。中断方式传送是单向的，对于 USB 主机而言，只有输入。中断传输方式主要用于定时查询设备是否有中断数据要传送，该传输方式应用在少量的、分散的、不可预测的数据传输场合，键盘、游戏杆和鼠标属于这一类型。
1. **批量(Bulk)**传输方式。批量传输主要应用在没有带宽和间隔时间要求的批量数据的传送和接收，它要求保证传输。打印机和扫描仪属于这种类型。

#### 2.3.4 以太网接口

以太网接口由 MAC(以太网媒体接入控制器)和 PHY(物理接口收发器)组成。以太网 MAC 由 IEEE-802.3 以太网标准定义，实现了数据链路层。常用的 MAC 支持 10Mbit/s 或 100Mbit/s 两种速率。PHY 则实现物理层功能，IEEE-802.3 标准定义了以太网 PHY。

组成一个以太网接口的硬件，从 CPU 到最终接口依次为：CPU、MAC、PHY、以太网隔离变压器、RJ45 插座。许多处理器内部集成了 MAC 或同时集成了 MAC 和 PHY，另有许多以太网控制芯片也集成 了MAC和PHY。

#### （未）2.3.5 ISA

ISA(工业标准结构总线)总线起源于1981年IBM生产的以Intel 8088为CPU的IBM-PC 微计算机，开始时总线宽度为 8 位。1984 年推出的 IBM-PC/AT 系统将 ISA 总线扩充为 16 位数据 总线宽度，同时地址总线宽度也由 20 位扩充到了 24 位。其后推出的 EISA(扩展的 ISA)采用 32 位地址线，数据总线也扩展为 32 位，但仍保持了与 ISA 的兼容。

#### （未）2.3.6 PCI 和 cPCI

### （未）2.4 CPLD 和 FPGA

CPLD(复杂可编程逻辑器件)由完全可编程的与或门阵列以及宏单元构成。

与 CPLD 不同，FPGA(现场可编程门阵列)基于LUT(查找表)工艺。

对于驱动工程师而言，我们只需要这样看待 CPLD 和 FPGA:如果它完成的是特定的接口和 控制功能，我们就直接把它当成由很多逻辑门(与、非、或、D 触发器)组成的完成一系列时序 逻辑和组合逻辑的 ASIC;如果它完成的是 CPU 的功能，我们就直接把它当成 CPU。

### （未）2.5 原理图分析

### （未）2.6 硬件时序分析

### （未）2.7 芯片手册阅读方法

### （未）2.8 仪器仪表的使用







